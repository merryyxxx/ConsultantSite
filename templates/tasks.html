{% extends 'base.html' %}

{% block extra_css %}
<style>
    .tasks-filters {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .tasks-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .tasks-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .tasks-list {
        padding: 0;
        margin: 0;
        list-style: none;
    }
    .task-item {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        transition: all 0.2s ease;
    }
    .task-item:last-child {
        border-bottom: none;
    }
    .task-item:hover {
        background-color: #f9f9f9;
    }
    .task-title {
        font-weight: 600;
        margin-bottom: 5px;
        cursor: pointer;
    }
    .task-meta {
        display: flex;
        font-size: 0.85rem;
        color: #7f8c8d;
        flex-wrap: wrap;
        gap: 15px;
    }
    .task-meta-item {
        display: flex;
        align-items: center;
    }
    .task-meta-item i {
        margin-right: 5px;
    }
    .task-priority {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 12px;
    }
    .task-priority.high {
        background-color: #ffebee;
        color: #e74c3c;
    }
    .task-priority.medium {
        background-color: #fff8e1;
        color: #f39c12;
    }
    .task-priority.low {
        background-color: #e8f5e9;
        color: #2ecc71;
    }
    .task-status {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 12px;
    }
    .task-status.pending {
        background-color: #f8f9fa;
        color: #495057;
    }
    .task-status.completed {
        background-color: #e8f5e9;
        color: #2ecc71;
    }
    .task-status.overdue {
        background-color: #ffebee;
        color: #e74c3c;
    }
    .task-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }
    .task-actions button {
        padding: 3px 10px;
        font-size: 0.8rem;
    }
    .empty-state {
        padding: 40px;
        text-align: center;
    }
    .empty-state-icon {
        font-size: 3rem;
        color: #c4c9cc;
        margin-bottom: 20px;
    }
    .no-results-found {
        display: none;
        padding: 40px;
        text-align: center;
    }
    .loading-spinner {
        display: flex;
        justify-content: center;
        padding: 40px;
    }
    .pagination-container {
        padding: 20px;
        display: flex;
        justify-content: center;
    }
    #completionModal .modal-header {
        border-left: 5px solid #2ecc71;
        background-color: #e8f5e9;
    }
    #completionModal .completed-icon {
        font-size: 3rem;
        color: #2ecc71;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0">Tasks</h1>
            <p class="text-muted">Manage and track your tasks</p>
        </div>
        {% if current_user.is_admin %}
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fas fa-plus me-1"></i> Add New Task
            </button>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="tasks-filters">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="priorityFilter" class="form-label">Priority</label>
                            <select class="form-select" id="priorityFilter">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    {% if current_user.is_admin %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="departmentFilter" class="form-label">Department</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="all">All</option>
                                {% for department in departments %}
                                <option value="{{ department.name }}">{{ department.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="searchFilter" class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchFilter" placeholder="Search tasks...">
                                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tasks-container">
                <div class="tasks-header">
                    <h4 class="mb-0">Task List</h4>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-sort me-1"></i> Sort
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item sort-option" data-sort="due_date">Due Date</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="priority">Priority</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="title">Title</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <ul class="tasks-list" id="tasksList">
                    <!-- Tasks will be loaded dynamically -->
                </ul>
                
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h4>No Tasks Available</h4>
                    <p class="text-muted">You don't have any tasks assigned to you yet.</p>
                    {% if current_user.is_admin %}
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="fas fa-plus me-1"></i> Create Task
                    </button>
                    {% endif %}
                </div>
                
                <div class="no-results-found" id="noResultsFound">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h4>No Results Found</h4>
                    <p class="text-muted">Try changing your search or filter criteria.</p>
                    <button class="btn btn-outline-secondary mt-3" id="clearFiltersBtn">
                        <i class="fas fa-times me-1"></i> Clear Filters
                    </button>
                </div>
                
                <div class="pagination-container">
                    <nav aria-label="Task pagination">
                        <ul class="pagination" id="taskPagination">
                            <!-- Pagination will be dynamically generated -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding a new task (admin only) -->
{% if current_user.is_admin %}
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Task Title*</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskDueDate" class="form-label">Due Date*</label>
                            <input type="date" class="form-control" id="taskDueDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskPriority" class="form-label">Priority*</label>
                            <select class="form-select" id="taskPriority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskAssignee" class="form-label">Assignee*</label>
                        <select class="form-select" id="taskAssignee" required>
                            <option value="">Select Assignee</option>
                            <!-- User options will be loaded dynamically -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">Save Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing a task (admin only) -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label for="editTaskTitle" class="form-label">Task Title*</label>
                        <input type="text" class="form-control" id="editTaskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTaskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editTaskDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskDueDate" class="form-label">Due Date*</label>
                            <input type="date" class="form-control" id="editTaskDueDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTaskPriority" class="form-label">Priority*</label>
                            <select class="form-select" id="editTaskPriority" required>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editTaskAssignee" class="form-label">Assignee*</label>
                            <select class="form-select" id="editTaskAssignee" required>
                                <option value="">Select Assignee</option>
                                <!-- User options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editTaskStatus" class="form-label">Status*</label>
                            <select class="form-select" id="editTaskStatus" required>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn">Delete Task</button>
                <button type="button" class="btn btn-primary" id="updateTaskBtn">Update Task</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal for viewing task details (non-admin users) -->
<div class="modal fade" id="viewTaskModal" tabindex="-1" aria-labelledby="viewTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTaskModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="viewTaskTitle"></h4>
                <div class="d-flex gap-2 mb-3">
                    <span class="task-priority" id="viewTaskPriority"></span>
                    <span class="task-status" id="viewTaskStatus"></span>
                </div>
                <p class="text-muted mb-1"><strong>Due Date:</strong> <span id="viewTaskDueDate"></span></p>
                <p class="text-muted mb-3"><strong>Assigned By:</strong> <span id="viewTaskCreator"></span></p>
                <h6>Description:</h6>
                <p id="viewTaskDescription" class="mb-4"></p>
                
                {% if not current_user.is_admin %}
                <div class="form-check mb-3" id="taskCompletionCheck">
                    <input class="form-check-input" type="checkbox" id="markTaskCompleted">
                    <label class="form-check-label" for="markTaskCompleted">
                        Mark as Completed
                    </label>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if not current_user.is_admin %}
                <button type="button" class="btn btn-success" id="saveTaskStatusBtn">Save Status</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Task completion confirmation modal -->
<div class="modal fade" id="completionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Completed!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="completed-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4>Great job!</h4>
                <p>You've successfully completed the task. Keep up the good work!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete task confirmation modal -->
<div class="modal fade" id="deleteTaskConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this task? This action cannot be undone.</p>
                <p class="fw-bold" id="deleteTaskName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTaskBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const tasksList = document.getElementById('tasksList');
        const emptyState = document.getElementById('emptyState');
        const noResultsFound = document.getElementById('noResultsFound');
        const loadingSpinner = document.querySelector('.loading-spinner');
        
        // Filters
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        const searchFilter = document.getElementById('searchFilter');
        const searchButton = document.getElementById('searchButton');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const departmentFilter = document.getElementById('departmentFilter');
        
        // Sort options
        const sortOptions = document.querySelectorAll('.sort-option');
        
        // Variables
        let currentTasks = [];
        let currentSort = 'due_date';
        let currentSortDirection = 'asc';
        
        // Load tasks initially
        loadTasks();
        
        // Load users for task assignment (admin only)
        {% if current_user.is_admin %}
        loadUsers();
        {% endif %}
        
        // Event listeners for filters
        statusFilter.addEventListener('change', loadTasks);
        priorityFilter.addEventListener('change', loadTasks);
        searchButton.addEventListener('click', loadTasks);
        searchFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadTasks();
            }
        });
        
        {% if current_user.is_admin %}
        if (departmentFilter) {
            departmentFilter.addEventListener('change', loadTasks);
        }
        {% endif %}
        
        // Clear filters
        clearFiltersBtn.addEventListener('click', function() {
            statusFilter.value = 'all';
            priorityFilter.value = 'all';
            searchFilter.value = '';
            {% if current_user.is_admin %}
            if (departmentFilter) {
                departmentFilter.value = 'all';
            }
            {% endif %}
            loadTasks();
        });
        
        // Sort tasks
        sortOptions.forEach(option => {
            option.addEventListener('click', function() {
                const sortBy = this.getAttribute('data-sort');
                
                if (currentSort === sortBy) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort = sortBy;
                    currentSortDirection = 'asc';
                }
                
                displayTasks(currentTasks);
            });
        });
        
        // Load tasks function
        function loadTasks() {
            showLoading();
            
            const status = statusFilter.value;
            const priority = priorityFilter.value;
            const searchQuery = searchFilter.value;
            
            let url = `/api/tasks?status=${status}&priority=${priority}`;
            
            if (searchQuery) {
                url += `&q=${encodeURIComponent(searchQuery)}`;
            }
            
            {% if current_user.is_admin %}
            if (departmentFilter) {
                url += `&department=${departmentFilter.value}`;
            }
            {% endif %}
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    currentTasks = data;
                    displayTasks(data);
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                    hideLoading();
                    showError('Failed to load tasks. Please try again later.');
                });
        }
        
        // Display tasks
        function displayTasks(tasks) {
            hideLoading();
            
            // Sort tasks
            tasks = sortTasks(tasks, currentSort, currentSortDirection);
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '';
                emptyState.style.display = 'block';
                noResultsFound.style.display = 'none';
                
                // Check if there are filters applied
                if (statusFilter.value !== 'all' || priorityFilter.value !== 'all' || searchFilter.value !== '') {
                    emptyState.style.display = 'none';
                    noResultsFound.style.display = 'block';
                }
                
                return;
            }
            
            // Hide empty states
            emptyState.style.display = 'none';
            noResultsFound.style.display = 'none';
            
            // Build task list
            let html = '';
            
            tasks.forEach(task => {
                const isOverdue = task.is_overdue ? 'overdue' : task.status;
                const targetModal = {% if current_user.is_admin %}'#editTaskModal'{% else %}'#viewTaskModal'{% endif %};
                
                html += `
                <li class="task-item" data-task-id="${task.id}">
                    <div class="task-title" data-bs-toggle="modal" data-bs-target="${targetModal}">${task.title}</div>
                    <div class="task-meta">
                        <div class="task-meta-item">
                            <i class="far fa-calendar-alt"></i> ${formatDate(task.due_date)}
                        </div>
                        <div class="task-meta-item">
                            <i class="far fa-user"></i> ${task.assignee_name}
                        </div>
                        <div class="task-meta-item">
                            <span class="task-priority ${task.priority}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                        <div class="task-meta-item">
                            <span class="task-status ${isOverdue}">${isOverdue.charAt(0).toUpperCase() + isOverdue.slice(1)}</span>
                        </div>
                    </div>
                    {% if not current_user.is_admin %}
                    <div class="task-actions">
                        <button class="btn btn-sm btn-success complete-task-btn" data-task-id="${task.id}" ${task.status === 'completed' ? 'disabled' : ''}>
                            <i class="fas fa-check me-1"></i> ${task.status === 'completed' ? 'Completed' : 'Mark Complete'}
                        </button>
                    </div>
                    {% endif %}
                </li>
                `;
            });
            
            tasksList.innerHTML = html;
            
            // Add event listeners to task items
            document.querySelectorAll('.task-item').forEach(item => {
                item.querySelector('.task-title').addEventListener('click', function() {
                    const taskId = item.getAttribute('data-task-id');
                    const task = tasks.find(t => t.id == taskId);
                    
                    if (task) {
                        {% if current_user.is_admin %}
                        openEditTaskModal(task);
                        {% else %}
                        openViewTaskModal(task);
                        {% endif %}
                    }
                });
            });
            
            {% if not current_user.is_admin %}
            // Add event listeners to complete buttons
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const taskId = this.getAttribute('data-task-id');
                    markTaskAsCompleted(taskId);
                });
            });
            {% endif %}
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }
        
        // Sort tasks
        function sortTasks(tasks, sortBy, direction) {
            return [...tasks].sort((a, b) => {
                let valueA, valueB;
                
                if (sortBy === 'due_date') {
                    valueA = new Date(a.due_date);
                    valueB = new Date(b.due_date);
                } else if (sortBy === 'priority') {
                    const priorityMap = { 'low': 1, 'medium': 2, 'high': 3 };
                    valueA = priorityMap[a.priority];
                    valueB = priorityMap[b.priority];
                } else {
                    valueA = a[sortBy];
                    valueB = b[sortBy];
                }
                
                if (direction === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
        }
        
        // Show loading spinner
        function showLoading() {
            loadingSpinner.style.display = 'flex';
            tasksList.style.display = 'none';
        }
        
        // Hide loading spinner
        function hideLoading() {
            loadingSpinner.style.display = 'none';
            tasksList.style.display = 'block';
        }
        
        // Show error message
        function showError(message) {
            alert(message);
        }
        
        {% if current_user.is_admin %}
        // Load users for task assignment
        function loadUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    populateUserDropdowns(users);
                })
                .catch(error => console.error('Error loading users:', error));
        }
        
        // Populate user dropdowns
        function populateUserDropdowns(users) {
            const taskAssignee = document.getElementById('taskAssignee');
            const editTaskAssignee = document.getElementById('editTaskAssignee');
            
            let html = '<option value="">Select Assignee</option>';
            
            users.forEach(user => {
                if (user.is_active) {
                    html += `<option value="${user.id}">${user.full_name || user.username} (${user.department})</option>`;
                }
            });
            
            taskAssignee.innerHTML = html;
            editTaskAssignee.innerHTML = html;
        }
        
        // Add task event
        document.getElementById('saveTaskBtn').addEventListener('click', function() {
            // Validate form
            const taskTitle = document.getElementById('taskTitle').value;
            const taskDueDate = document.getElementById('taskDueDate').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskAssignee = document.getElementById('taskAssignee').value;
            const taskDescription = document.getElementById('taskDescription').value;
            
            if (!taskTitle || !taskDueDate || !taskPriority || !taskAssignee) {
                showError('Please fill all required fields.');
                return;
            }
            
            // Create task object
            const task = {
                title: taskTitle,
                description: taskDescription,
                due_date: taskDueDate,
                priority: taskPriority,
                assignee_id: taskAssignee
            };
            
            // Send API request
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(task)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create task');
                }
                return response.json();
            })
            .then(data => {
                // Close modal and reload tasks
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('addTaskForm').reset();
                
                // Reload tasks
                loadTasks();
            })
            .catch(error => {
                console.error('Error creating task:', error);
                showError('Failed to create task. Please try again.');
            });
        });
        
        // Open edit task modal
        function openEditTaskModal(task) {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskDueDate').value = task.due_date.split('T')[0];
            document.getElementById('editTaskPriority').value = task.priority;
            document.getElementById('editTaskAssignee').value = task.assignee_id;
            document.getElementById('editTaskStatus').value = task.status;
            
            // Show delete button
            document.getElementById('deleteTaskBtn').addEventListener('click', function() {
                const taskId = document.getElementById('editTaskId').value;
                const taskTitle = document.getElementById('editTaskTitle').value;
                
                // Show confirmation modal
                document.getElementById('deleteTaskName').textContent = taskTitle;
                
                // Close edit modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                editModal.hide();
                
                // Show delete confirmation modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteTaskConfirmModal'));
                deleteModal.show();
            });
        }
        
        // Update task event
        document.getElementById('updateTaskBtn').addEventListener('click', function() {
            // Validate form
            const taskId = document.getElementById('editTaskId').value;
            const taskTitle = document.getElementById('editTaskTitle').value;
            const taskDueDate = document.getElementById('editTaskDueDate').value;
            const taskPriority = document.getElementById('editTaskPriority').value;
            const taskAssignee = document.getElementById('editTaskAssignee').value;
            const taskDescription = document.getElementById('editTaskDescription').value;
            const taskStatus = document.getElementById('editTaskStatus').value;
            
            if (!taskTitle || !taskDueDate || !taskPriority || !taskAssignee || !taskStatus) {
                showError('Please fill all required fields.');
                return;
            }
            
            // Create task object
            const task = {
                title: taskTitle,
                description: taskDescription,
                due_date: taskDueDate,
                priority: taskPriority,
                assignee_id: taskAssignee,
                status: taskStatus
            };
            
            // Send API request
            fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(task)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update task');
                }
                return response.json();
            })
            .then(data => {
                // Close modal and reload tasks
                const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                modal.hide();
                
                // Reload tasks
                loadTasks();
            })
            .catch(error => {
                console.error('Error updating task:', error);
                showError('Failed to update task. Please try again.');
            });
        });
        
        // Delete task event
        document.getElementById('confirmDeleteTaskBtn').addEventListener('click', function() {
            const taskId = document.getElementById('editTaskId').value;
            
            // Send API request
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete task');
                }
                
                // Close modal and reload tasks
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTaskConfirmModal'));
                modal.hide();
                
                // Reload tasks
                loadTasks();
            })
            .catch(error => {
                console.error('Error deleting task:', error);
                showError('Failed to delete task. Please try again.');
            });
        });
        {% endif %}
        
        {% if not current_user.is_admin %}
        // Open view task modal
        function openViewTaskModal(task) {
            document.getElementById('viewTaskTitle').textContent = task.title;
            document.getElementById('viewTaskDescription').textContent = task.description || 'No description provided.';
            document.getElementById('viewTaskDueDate').textContent = formatDate(task.due_date);
            document.getElementById('viewTaskCreator').textContent = task.creator_name;
            
            // Set priority and status
            const priorityElement = document.getElementById('viewTaskPriority');
            priorityElement.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            priorityElement.className = `task-priority ${task.priority}`;
            
            const statusElement = document.getElementById('viewTaskStatus');
            const status = task.is_overdue ? 'overdue' : task.status;
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.className = `task-status ${status}`;
            
            // Set checkbox status
            const completedCheckbox = document.getElementById('markTaskCompleted');
            completedCheckbox.checked = task.status === 'completed';
            completedCheckbox.disabled = task.status === 'completed';
            
            // Show/hide task completion section
            const taskCompletionCheck = document.getElementById('taskCompletionCheck');
            const saveTaskStatusBtn = document.getElementById('saveTaskStatusBtn');
            
            if (task.status === 'completed') {
                taskCompletionCheck.style.display = 'none';
                saveTaskStatusBtn.style.display = 'none';
            } else {
                taskCompletionCheck.style.display = 'block';
                saveTaskStatusBtn.style.display = 'block';
            }
            
            // Save task status event
            document.getElementById('saveTaskStatusBtn').onclick = function() {
                markTaskAsCompleted(task.id);
            };
        }
        
        // Mark task as completed
        function markTaskAsCompleted(taskId) {
            fetch(`/api/tasks/${taskId}/complete`, {
                method: 'PUT'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update task status');
                }
                return response.json();
            })
            .then(data => {
                // Close view modal if open
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewTaskModal'));
                if (viewModal) {
                    viewModal.hide();
                }
                
                // Show completion modal
                const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
                completionModal.show();
                
                // Reload tasks
                loadTasks();
            })
            .catch(error => {
                console.error('Error updating task status:', error);
                showError('Failed to update task status. Please try again.');
            });
        }
        {% endif %}
    });
</script>
{% endblock %}